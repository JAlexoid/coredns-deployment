#!/usr/bin/make -ef

include /usr/share/dpkg/architecture.mk

DPKG_COREDNS_VERSION := $(shell curl -s https://api.github.com/repos/coredns/coredns/releases/latest  | jq -r '.tag_name[1:length]')
DPKG_GO_VERSION 	 := $(shell go version | { read _ _ v _; echo ${v}; })
# Github is ratelimiting this API pretty aggresively, error when not set.
ifeq ($(DPKG_COREDNS_VERSION),null)
    $(error No version found)
endif

DEB_HOST_ARCH               := $(DEB_TARGET_ARCH)
DPKG_COREDNS_DISTRIBUTION   := $(shell lsb_release -sr)
PACKAGEVERSION              := $(DPKG_COREDNS_VERSION)-$(DPKG_GO_VERSION)-$(DPKG_COREDNS_DISTRIBUTION)-extras
VTARBALL                    := v$(DPKG_COREDNS_VERSION).tar.gz
SOURCE_BASE					:= src/v$(DPKG_COREDNS_VERSION)
SOURCE_DIR					:= $(SOURCE_BASE)/coredns-$(DPKG_COREDNS_VERSION)


SRC := https://github.com/coredns/coredns/archive/v$(DPKG_COREDNS_VERSION).tar.gz

%:
	dh_clean
	dh $@ --with systemd

override_dh_strip:
	# don't perform dh_strip
	echo dh_strip

override_dh_auto_clean:
override_dh_auto_test:
override_dh_auto_build:
override_dh_auto_install:
	if [ ! -e $(VTARBALL) ]; then  curl -L $(SRC) -o $(VTARBALL); fi
	mkdir -p $(SOURCE_BASE)
	tar -xf $(VTARBALL) -C $(SOURCE_BASE)
	cat extra-plugins.cfg >> $(SOURCE_DIR)/plugin.cfg
	cd $(SOURCE_DIR) && make SYSTEM="GOARCH=$(DEB_TARGET_ARCH)"
	mkdir -p debian/man debian/coredns/usr/bin debian/coredns/etc/coredns
	cp $(SOURCE_DIR)/coredns debian/coredns/usr/bin/
	cp $(SOURCE_DIR)/man/* debian/man/
	cp debian/Corefile debian/coredns/etc/coredns/Corefile

override_dh_gencontrol:
	dh_gencontrol -- -v$(PACKAGEVERSION)
